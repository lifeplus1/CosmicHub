<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astrology App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
    <style>
        body { padding: 20px; background: #f4f6f9; font-family: 'Arial', sans-serif; }
        .card { margin-bottom: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .retrograde { color: #dc3545; font-weight: bold; }
        .trine, .sextile { color: #28a745; }
        .square, .opposition { color: #dc3545; }
        .conjunction { color: #007bff; }
        .quincunx, .sesquiquadrate { color: #6f42c1; }
        .semi-sextile, .quintile, .bi-quintile { color: #6c757d; }
        .zodiac-icon { font-size: 1.2em; margin-right: 5px; }
        .chart-container { display: flex; justify-content: center; margin-bottom: 20px; }
        svg { background: #ffffff; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .chart-title { font-size: 1.5em; font-weight: bold; text-align: center; margin-bottom: 10px; }
        .auth-container { max-width: 400px; margin: 0 auto; }
        .auth-error { color: #dc3545; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Birth Chart Calculator</h1>

        <div id="authSection" class="auth-container mb-4">
            <div id="authCard" class="card">
                <div class="card-body">
                    <h2 class="card-title text-center">Login / Sign Up</h2>
                    <form id="authForm">
                        <div class="mb-3">
                            <label class="form-label">Email:</label>
                            <input type="email" class="form-control" id="authEmail" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password:</label>
                            <input type="password" class="form-control" id="authPassword" required>
                        </div>
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-primary" onclick="signIn()">Login</button>
                            <button type="button" class="btn btn-secondary" onclick="signUp()">Sign Up</button>
                        </div>
                        <p id="authError" class="auth-error mt-2"></p>
                    </form>
                    <button id="signOut" class="btn btn-danger mt-3" style="display: none;">Sign Out</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h2 class="card-title">Natal Chart</h2>
                <form id="birthForm">
                    <div class="mb-3">
                        <label class="form-label">Year:</label>
                        <input type="number" class="form-control" name="year" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Month:</label>
                        <input type="number" class="form-control" name="month" min="1" max="12" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Day:</label>
                        <input type="number" class="form-control" name="day" min="1" max="31" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Hour:</label>
                        <input type="number" class="form-control" name="hour" min="0" max="23" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Minute:</label>
                        <input type="number" class="form-control" name="minute" min="0" max="59" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">City:</label>
                        <input type="text" class="form-control" name="city" required placeholder="e.g., New York, USA">
                    </div>
                    <button type="submit" class="btn btn-primary">Calculate Natal</button>
                </form>
            </div>
        </div>
        <div id="result"></div>

        <div class="card">
            <div class="card-body">
                <h2 class="card-title">Transits</h2>
                <form id="transitForm">
                    <div class="mb-3">
                        <label class="form-label">Year:</label>
                        <input type="number" class="form-control" name="natal[year]" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Month:</label>
                        <input type="number" class="form-control" name="natal[month]" min="1" max="12" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Day:</label>
                        <input type="number" class="form-control" name="natal[day]" min="1" max="31" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Hour:</label>
                        <input type="number" class="form-control" name="natal[hour]" min="0" max="23" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Minute:</label>
                        <input type="number" class="form-control" name="natal[minute]" min="0" max="59" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">City:</label>
                        <input type="text" class="form-control" name="natal[city]" required placeholder="e.g., New York, USA">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Transit Date (YYYY-MM-DD):</label>
                        <input type="text" class="form-control" name="transit_date" value="2025-07-28" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Calculate Transits</button>
                </form>
            </div>
        </div>
        <div id="transitResult"></div>

        <div class="card" id="savedChartsCard" style="display: none;">
            <div class="card-body">
                <h2 class="card-title">Saved Charts</h2>
                <button id="loadCharts" class="btn btn-secondary">Load Saved Charts</button>
                <div id="savedCharts" class="mt-3"></div>
            </div>
        </div>

        <script>
            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyDEQ5i07TflWq30lwBsoJLzGNEUgSNLTOw",
                authDomain: "astrology-app-9c2e9.firebaseapp.com",
                projectId: "astrology-app-9c2e9",
                storageBucket: "astrology-app-9c2e9.firebasestorage.app",
                messagingSenderId: "341259782663",
                appId: "1:341259782663:web:132d7b85d8518c5f3bf8a2",
                measurementId: "G-M2776G401M"
            };
            firebase.initializeApp(firebaseConfig);

            // Global variables and functions
            let chartStore = {};
            let API_KEY = '';
            let fetchWithRetry;
            let currentUser = null;

            const zodiacIcons = {
                'Aries': 'â™ˆ',
                'Taurus': 'â™‰',
                'Gemini': 'â™Š',
                'Cancer': 'â™‹',
                'Leo': 'â™Œ',
                'Virgo': 'â™',
                'Libra': 'â™Ž',
                'Scorpio': 'â™',
                'Sagittarius': 'â™',
                'Capricorn': 'â™‘',
                'Aquarius': 'â™’',
                'Pisces': 'â™“'
            };

            const signs = ['Aries', 'Taurus', 'Gemini', 'Cancer', 'Leo', 'Virgo', 'Libra', 'Scorpio', 'Sagittarius', 'Capricorn', 'Aquarius', 'Pisces'];

            const planetSymbols = {
                'Sun': 'â˜‰',
                'Moon': 'â˜½',
                'Mercury': 'â˜¿',
                'Venus': 'â™€',
                'Mars': 'â™‚',
                'Jupiter': 'â™ƒ',
                'Saturn': 'â™„',
                'Uranus': 'â™…',
                'Neptune': 'â™†',
                'Pluto': 'â™‡',
                'Chiron': 'âš·',
                'North Node': 'â˜Š',
                'South Node': 'â˜‹',
                'Ascendant': 'Asc',
                'Descendant': 'DC',
                'Midheaven': 'MC',
                'Vertex': 'Vx',
                'Antivertex': 'Avx',
                'IC': 'IC'
            };

            const aspectStyles = {
                'Conjunction': { color: '#007bff', strokeWidth: 2, dash: '' },
                'Trine': { color: '#28a745', strokeWidth: 2, dash: '' },
                'Sextile': { color: '#28a745', strokeWidth: 1, dash: '5,5' },
                'Square': { color: '#dc3545', strokeWidth: 2, dash: '' },
                'Opposition': { color: '#dc3545', strokeWidth: 2, dash: '10,5' },
                'Quincunx': { color: '#6f42c1', strokeWidth: 1, dash: '5,5' },
                'Sesquiquadrate': { color: '#6f42c1', strokeWidth: 1, dash: '5,5' },
                'Semi-Sextile': { color: '#6c757d', strokeWidth: 1, dash: '3,3' },
                'Quintile': { color: '#6c757d', strokeWidth: 1, dash: '3,3' },
                'Bi-Quintile': { color: '#6c757d', strokeWidth: 1, dash: '3,3' }
            };

            function signIn() {
                const email = document.getElementById('authEmail').value;
                const password = document.getElementById('authPassword').value;
                firebase.auth().signInWithEmailAndPassword(email, password)
                    .then(userCredential => {
                        currentUser = userCredential.user;
                        updateAuthUI();
                    })
                    .catch(error => {
                        document.getElementById('authError').textContent = `Error: ${error.message}`;
                    });
            }

            function signUp() {
                const email = document.getElementById('authEmail').value;
                const password = document.getElementById('authPassword').value;
                firebase.auth().createUserWithEmailAndPassword(email, password)
                    .then(userCredential => {
                        currentUser = userCredential.user;
                        updateAuthUI();
                    })
                    .catch(error => {
                        document.getElementById('authError').textContent = `Error: ${error.message}`;
                    });
            }

            function signOut() {
                firebase.auth().signOut().then(() => {
                    currentUser = null;
                    updateAuthUI();
                });
            }

            function updateAuthUI() {
                const authCard = document.getElementById('authCard');
                const signOutBtn = document.getElementById('signOut');
                const savedChartsCard = document.getElementById('savedChartsCard');
                if (currentUser) {
                    authCard.style.display = 'none';
                    signOutBtn.style.display = 'block';
                    savedChartsCard.style.display = 'block';
                } else {
                    authCard.style.display = 'block';
                    signOutBtn.style.display = 'none';
                    savedChartsCard.style.display = 'none';
                }
            }

            async function saveChart(chartId) {
                if (!currentUser) {
                    alert('Please log in to save charts.');
                    return;
                }
                const { birthData, chartData, chartType } = chartStore[chartId] || {};
                if (!birthData || !chartData || !chartType) {
                    alert('Error: Chart data not found');
                    return;
                }
                try {
                    const idToken = await currentUser.getIdToken();
                    const response = await fetchWithRetry('https://astrology-app-065g.onrender.com/save-chart', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}`
                        },
                        body: JSON.stringify({ chart_type: chartType, birth_data: birthData, chart_data: chartData })
                    });
                    alert(response.message);
                    await loadSavedCharts();
                } catch (error) {
                    alert(`Error saving chart: ${error.message}`);
                }
            }

            async function loadSavedCharts() {
                if (!currentUser) {
                    document.getElementById('savedCharts').innerHTML = '<p class="alert alert-warning">Please log in to view saved charts.</p>';
                    return;
                }
                const savedCharts = document.getElementById('savedCharts');
                if (!savedCharts) {
                    console.error('Element with ID savedCharts not found');
                    return;
                }
                try {
                    const idToken = await currentUser.getIdToken();
                    const charts = await fetchWithRetry('https://astrology-app-065g.onrender.com/get-charts', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}`
                        }
                    });
                    let html = '<h3>Saved Charts</h3>';
                    if (charts.length === 0) {
                        html += '<p>No saved charts found.</p>';
                    } else {
                        charts.forEach(chart => {
                            html += `<div class="card mb-3"><div class="card-body">`;
                            html += `<h4>${chart.type} Chart (Saved: ${new Date(chart.created_at).toLocaleString()})</h4>`;
                            html += `<p>Birth Data: ${JSON.stringify(chart.birth_data)}</p>`;
                            html += `<div id="savedChart_${chart.id}" class="chart-container"></div>`;
                            setTimeout(() => {
                                if (chart.type === 'natal') {
                                    displayResult(chart.chart_data, `savedChart_${chart.id}`, null, null);
                                } else {
                                    displayTransitResult(chart.chart_data, null);
                                }
                            }, 0);
                            html += `</div></div>`;
                        });
                    }
                    savedCharts.innerHTML = html;
                } catch (error) {
                    savedCharts.innerHTML = `<p class="alert alert-danger">Error loading charts: ${error.message}</p>`;
                }
            }

            document.addEventListener('DOMContentLoaded', async () => {
                // Initialize Firebase auth state listener
                firebase.auth().onAuthStateChanged(user => {
                    currentUser = user;
                    updateAuthUI();
                });

                // Create tooltip div
                const tooltip = d3.select('body').append('div')
                    .attr('class', 'tooltip')
                    .style('display', 'none');

                // Fetch API key with retry
                const maxRetries = 3;
                let retries = 0;
                while (retries < maxRetries) {
                    try {
                        const response = await fetch('/api/get-api-key', { method: 'GET' });
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`HTTP ${response.status} - ${errorText}`);
                        }
                        const data = await response.json();
                        API_KEY = data.apiKey;
                        if (!API_KEY) throw new Error('API key not found in response');
                        console.log('API key fetched successfully');
                        break;
                    } catch (error) {
                        retries++;
                        console.error(`Attempt ${retries} failed to fetch API key:`, error.message);
                        if (retries === maxRetries) {
                            document.getElementById('result').innerHTML = `<p class="alert alert-danger">Error: Unable to load API key - ${error.message}. Please check server configuration.</p>`;
                            return;
                        }
                        await new Promise(resolve => setTimeout(resolve, 1000 * retries));
                    }
                }

                fetchWithRetry = async (url, options, retries = 3, delay = 1000) => {
                    for (let i = 0; i < retries; i++) {
                        try {
                            const response = await fetch(url, {
                                ...options,
                                headers: {
                                    ...options.headers,
                                    'X-API-Key': API_KEY
                                },
                                signal: AbortSignal.timeout(90000)
                            });
                            if (!response.ok) {
                                const errorText = await response.text();
                                throw new Error(`HTTP ${response.status} - ${errorText}`);
                            }
                            return await response.json();
                        } catch (error) {
                            if (i === retries - 1) throw error;
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                    }
                };

                function drawChart(elementId, planets, houses, angles, aspects) {
                    const width = 500, height = 500, radius = 200;
                    const innerRadius = radius - 80;
                    const svg = d3.select(`#${elementId}`)
                        .append('svg')
                        .attr('width', width)
                        .attr('height', height)
                        .append('g')
                        .attr('transform', `translate(${width / 2}, ${height / 2})`);

                    // Background circle with gradient
                    const gradient = svg.append('defs')
                        .append('radialGradient')
                        .attr('id', 'chartGradient')
                        .attr('cx', '50%')
                        .attr('cy', '50%')
                        .attr('r', '50%');
                    gradient.append('stop')
                        .attr('offset', '0%')
                        .attr('stop-color', '#ffffff');
                    gradient.append('stop')
                        .attr('offset', '100%')
                        .attr('stop-color', '#e9ecef');
                    svg.append('circle')
                        .attr('r', radius)
                        .attr('fill', 'url(#chartGradient)')
                        .attr('stroke', '#333')
                        .attr('stroke-width', 2);

                    // Zodiac circle
                    const zodiacArc = d3.arc().innerRadius(radius - 40).outerRadius(radius);
                    const zodiacData = signs.map((sign, i) => ({
                        sign,
                        startAngle: (i * 30) * Math.PI / 180,
                        endAngle: ((i + 1) * 30) * Math.PI / 180
                    }));

                    svg.selectAll('.zodiac')
                        .data(zodiacData)
                        .enter()
                        .append('path')
                        .attr('d', zodiacArc)
                        .attr('fill', '#f8f9fa')
                        .attr('stroke', '#666')
                        .attr('stroke-width', 1);

                    svg.selectAll('.zodiac-label')
                        .data(zodiacData)
                        .enter()
                        .append('text')
                        .attr('transform', d => `translate(${Math.cos(d.startAngle + 15 * Math.PI / 180) * (radius - 20)}, ${Math.sin(d.startAngle + 15 * Math.PI / 180) * (radius - 20)})`)
                        .attr('text-anchor', 'middle')
                        .attr('font-size', '16px')
                        .attr('font-weight', 'bold')
                        .attr('fill', '#333')
                        .text(d => zodiacIcons[d.sign]);

                    // House cusps
                    houses.forEach(h => {
                        const cuspValue = parseFloat(h.cusp);
                        if (!isNaN(cuspValue)) {
                            const angle = (cuspValue * Math.PI / 180) - (Math.PI / 2);
                            svg.append('line')
                                .attr('x1', innerRadius * Math.cos(angle))
                                .attr('y1', innerRadius * Math.sin(angle))
                                .attr('x2', radius * Math.cos(angle))
                                .attr('y2', radius * Math.sin(angle))
                                .attr('stroke', '#333')
                                .attr('stroke-width', 1.5);
                            // House number
                            svg.append('text')
                                .attr('x', (innerRadius - 10) * Math.cos(angle))
                                .attr('y', (innerRadius - 10) * Math.sin(angle))
                                .attr('text-anchor', 'middle')
                                .attr('font-size', '12px')
                                .attr('fill', '#555')
                                .text(h.house);
                        }
                    });

                    // Add Descendant to angles
                    if (angles['Ascendant'] && !isNaN(angles['Ascendant'].lon)) {
                        angles['Descendant'] = {
                            lon: (angles['Ascendant'].lon + 180) % 360,
                            position: `${Math.floor((angles['Ascendant'].lon + 180) % 360)}Â°${signs[Math.floor(((angles['Ascendant'].lon + 180) % 360) / 30)]}${Math.floor(((angles['Ascendant'].lon + 180) % 360 - Math.floor((angles['Ascendant'].lon + 180) % 360)) * 60)}'`,
                            sign: signs[Math.floor(((angles['Ascendant'].lon + 180) % 360) / 30)],
                            house: angles['Ascendant'].house <= 6 ? angles['Ascendant'].house + 6 : angles['Ascendant'].house - 6
                        };
                    }

                    // Aspect lines with tooltips
                    aspects.forEach(a => {
                        const point1 = planetSymbols[a.point1] ? planets[a.point1] : angles[a.point1];
                        const point2 = planetSymbols[a.point2] ? planets[a.point2] : angles[a.point2];
                        if (point1 && point2 && !isNaN(point1.lon) && !isNaN(point2.lon)) {
                            const style = aspectStyles[a.aspect] || { color: '#6c757d', strokeWidth: 1, dash: '' };
                            const angle1 = (point1.lon * Math.PI / 180) - (Math.PI / 2);
                            const angle2 = (point2.lon * Math.PI / 180) - (Math.PI / 2);
                            const r = innerRadius + 20;
                            svg.append('line')
                                .attr('x1', r * Math.cos(angle1))
                                .attr('y1', r * Math.sin(angle1))
                                .attr('x2', r * Math.cos(angle2))
                                .attr('y2', r * Math.sin(angle2))
                                .attr('stroke', style.color)
                                .attr('stroke-width', style.strokeWidth)
                                .attr('stroke-dasharray', style.dash)
                                .on('mouseover', function(event) {
                                    tooltip.style('display', 'block')
                                        .html(`${planetSymbols[a.point1] || a.point1} ${a.aspect} ${planetSymbols[a.point2] || a.point2}<br>Orb: ${a.orb}`)
                                        .style('left', (event.pageX + 10) + 'px')
                                        .style('top', (event.pageY - 10) + 'px');
                                })
                                .on('mouseout', function() {
                                    tooltip.style('display', 'none');
                                });
                        }
                    });

                    // Planets
                    for (let planet in planets) {
                        const lon = planets[planet].lon;
                        if (!isNaN(lon)) {
                            const angle = (lon * Math.PI / 180) - (Math.PI / 2);
                            const r = innerRadius + 30;
                            svg.append('text')
                                .attr('x', r * Math.cos(angle))
                                .attr('y', r * Math.sin(angle))
                                .attr('text-anchor', 'middle')
                                .attr('font-size', '14px')
                                .attr('font-weight', 'bold')
                                .attr('fill', planets[planet].retrograde ? '#dc3545' : '#007bff')
                                .text(planetSymbols[planet] || planet.substring(0, 3));
                        }
                    }

                    // Angles
                    for (let angle in angles) {
                        const lon = angles[angle].lon;
                        if (!isNaN(lon)) {
                            const rad = (lon * Math.PI / 180) - (Math.PI / 2);
                            svg.append('line')
                                .attr('x1', innerRadius * Math.cos(rad))
                                .attr('y1', innerRadius * Math.sin(rad))
                                .attr('x2', radius * Math.cos(rad))
                                .attr('y2', radius * Math.sin(rad))
                                .attr('stroke', '#333')
                                .attr('stroke-width', 2);
                            svg.append('text')
                                .attr('x', (innerRadius + 40) * Math.cos(rad))
                                .attr('y', (innerRadius + 40) * Math.sin(rad))
                                .attr('text-anchor', 'middle')
                                .attr('font-size', '14px')
                                .attr('font-weight', 'bold')
                                .attr('fill', '#333')
                                .text(planetSymbols[angle] || angle.substring(0, 3));
                        }
                    }
                }

                function displayResult(result, elementId, birthData, chartType) {
                    const chartId = Date.now().toString();
                    chartStore[chartId] = { birthData, chartData: result, chartType };

                    let html = `<div class="chart-title">${chartType === 'natal' ? 'Natal Chart' : 'Transit Chart'}</div>`;
                    html += '<div class="chart-container"><div id="chart_' + chartId + '"></div></div>';
                    html += '<h3>Resolved Location</h3>';
                    html += `<p>City: ${result.resolved_location.city}<br>Lat: ${result.resolved_location.latitude}<br>Lon: ${result.resolved_location.longitude}<br>Timezone: ${result.resolved_location.timezone}</p>`;

                    html += '<h3>Planets</h3><table class="table table-striped"><thead><tr><th>Planet</th><th>Position</th><th>Sign</th><th>House</th><th>Retrograde</th></tr></thead><tbody>';
                    for (let planet in result.planets) {
                        let p = result.planets[planet];
                        let retroClass = p.retrograde ? 'class="retrograde"' : '';
                        let icon = zodiacIcons[p.sign] || '';
                        html += `<tr><td>${planetSymbols[planet] || planet}</td><td>${p.position}</td><td><span class="zodiac-icon">${icon}</span>${p.sign}</td><td>${p.house}</td><td ${retroClass}>${p.retrograde ? 'Yes ðŸš«' : 'No'}</td></tr>`;
                    }
                    html += '</tbody></table>';

                    html += '<h3>Houses</h3><table class="table table-striped"><thead><tr><th>House</th><th>Cusp</th><th>Sign</th></tr></thead><tbody>';
                    result.houses.forEach(h => {
                        let icon = zodiacIcons[h.sign] || '';
                        html += `<tr><td>${h.house}</td><td>${h.cusp}</td><td><span class="zodiac-icon">${icon}</span>${h.sign}</td></tr>`;
                    });
                    html += '</tbody></table>';

                    html += '<h3>Angles</h3><table class="table table-striped"><thead><tr><th>Angle</th><th>Position</th><th>Sign</th><th>House</th></tr></thead><tbody>';
                    // Add Descendant to angles for display
                    const displayAngles = { ...result.angles };
                    if (result.angles['Ascendant'] && !isNaN(result.angles['Ascendant'].lon)) {
                        displayAngles['Descendant'] = {
                            position: `${Math.floor((result.angles['Ascendant'].lon + 180) % 360)}Â°${signs[Math.floor(((result.angles['Ascendant'].lon + 180) % 360) / 30)]}${Math.floor(((result.angles['Ascendant'].lon + 180) % 360 - Math.floor((result.angles['Ascendant'].lon + 180) % 360)) * 60)}'`,
                            sign: signs[Math.floor(((result.angles['Ascendant'].lon + 180) % 360) / 30)],
                            house: result.angles['Ascendant'].house <= 6 ? result.angles['Ascendant'].house + 6 : result.angles['Ascendant'].house - 6
                        };
                    }
                    for (let angle in displayAngles) {
                        let a = displayAngles[angle];
                        let icon = zodiacIcons[a.sign] || '';
                        html += `<tr><td>${planetSymbols[angle] || angle}</td><td>${a.position}</td><td><span class="zodiac-icon">${icon}</span>${a.sign}</td><td>${a.house}</td></tr>`;
                    }
                    html += '</tbody></table>';

                    html += '<h3>Aspects</h3><table class="table table-striped"><thead><tr><th>Point1</th><th>Point2</th><th>Aspect</th><th>Orb</th></tr></thead><tbody>';
                    result.aspects.forEach(a => {
                        let aspClass = a.aspect.toLowerCase().replace(' ', '-');
                        html += `<tr class="${aspClass}"><td>${planetSymbols[a.point1] || a.point1}</td><td>${planetSymbols[a.point2] || a.point2}</td><td>${a.aspect} ðŸ”„</td><td>${a.orb}</td></tr>`;
                    });
                    html += '</tbody></table>';

                    if (birthData && chartType && currentUser) {
                        html += `<button class="btn btn-success mb-3" onclick="saveChart('${chartId}')">Save Chart</button>`;
                    } else if (!currentUser) {
                        html += `<p class="alert alert-warning">Log in to save charts.</p>`;
                    }

                    const element = document.getElementById(elementId);
                    if (element) {
                        element.innerHTML = html;
                        setTimeout(() => drawChart('chart_' + chartId, result.planets, result.houses, { ...result.angles, ...displayAngles }, result.aspects), 0);
                    } else {
                        console.error(`Element with ID ${elementId} not found`);
                    }
                }

                function displayTransitResult(result, birthData) {
                    const chartId = Date.now().toString();
                    chartStore[chartId] = { birthData: birthData.natal, chartData: result, chartType: 'transit' };

                    let html = '<h3>Natal Chart</h3>';
                    html += '<div class="chart-container"><div id="natalChart_' + chartId + '"></div></div>';
                    displayResult(result.natal, 'transitResult', birthData.natal, 'transit');

                    html = document.getElementById('transitResult').innerHTML;
                    html += '<h3>Transit Planets</h3><table class="table table-striped"><thead><tr><th>Planet</th><th>Position</th><th>Sign</th></tr></thead><tbody>';
                    for (let planet in result.transits) {
                        let p = result.transits[planet];
                        let icon = zodiacIcons[p.sign] || '';
                        html += `<tr><td>${planetSymbols[planet] || planet}</td><td>${p.position}</td><td><span class="zodiac-icon">${icon}</span>${p.sign}</td></tr>`;
                    }
                    html += '</tbody></table>';

                    html += '<h3>Transit Aspects to Natal</h3><table class="table table-striped"><thead><tr><th>Transit Planet</th><th>Natal Point</th><th>Aspect</th><th>Orb</th></tr></thead><tbody>';
                    result.transit_aspects.forEach(a => {
                        let aspClass = a.aspect.toLowerCase().replace(' ', '-');
                        html += `<tr class="${aspClass}"><td>${planetSymbols[a.transit_planet] || a.transit_planet}</td><td>${planetSymbols[a.natal_point] || a.natal_point}</td><td>${a.aspect} ðŸ”„</td><td>${a.orb}</td></tr>`;
                    });
                    html += '</tbody></table>';

                    if (currentUser) {
                        html += `<button class="btn btn-success mb-3" onclick="saveChart('${chartId}')">Save Chart</button>`;
                    } else {
                        html += `<p class="alert alert-warning">Log in to save charts.</p>`;
                    }

                    const transitResult = document.getElementById('transitResult');
                    if (transitResult) {
                        transitResult.innerHTML = html;
                        setTimeout(() => drawChart('natalChart_' + chartId, result.natal.planets, result.natal.houses, { ...result.natal.angles, ...displayAngles }, result.natal.aspects), 0);
                    } else {
                        console.error('Element with ID transitResult not found');
                    }
                }

                document.getElementById('signOut').addEventListener('click', signOut);
                document.getElementById('loadCharts').addEventListener('click', loadSavedCharts);
            });
        </script>
    </div>
</body>
</html>